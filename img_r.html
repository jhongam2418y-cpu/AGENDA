<!DOCTYPE html>
<html lang="es" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="MobileOptimized" content="width" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Radiograf√≠as</title>
  <style>
    /* Estilos generales */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    
    /* Estilos para la pantalla de carga */
    #contenedor_carga {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.5s;
      opacity: 1;
      visibility: visible;
    }
    
    #carga {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #25eaa4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Estilos para los botones de navegaci√≥n */
    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 15px 0;
      margin-bottom: 20px;
    }
    
    .nav-button {
      padding: 10px 16px;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s;
      border: 1px solid #ddd;
      background-color: #e9ecef;
      color: #333;
      text-align: center;
      flex-grow: 1;
      min-width: 120px;
    }
    
    .nav-button:hover {
      background-color: #d3d4d5;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .nav-button.active {
      background-color: #565e64;
      color: white;
      border-bottom: 2px solid #25eaa4;
    }
    
    .nav-button.secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .nav-button.light {
      background-color: #f8f9fa;
    }
    
    /* Estilos para el formulario */
    .form-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-card {
      flex: 1;
      min-width: 250px;
      background-color: #2c3e50;
      border-radius: 8px;
      padding: 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .form-card img {
      width: 40px;
      height: 40px;
      filter: invert(1);
    }
    
    .form-card-content {
      flex-grow: 1;
    }
    
    .form-card p {
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .form-card input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Bot√≥n de guardar */
    .submit-btn {
      background-color: #25eaa4;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: block;
      margin: 0 auto;
    }
    
    .submit-btn:hover {
      background-color: #1fc98e;
    }
    
    /* Estilos para el carrusel */
    .carousel-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .carousel {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .carousel-inner {
      display: flex;
      transition: transform 0.5s ease;
    }
    
    .carousel-item {
      min-width: 100%;
      position: relative;
    }
    
    .carousel-item img {
      width: 100%;
      height: 400px;
      object-fit: contain;
      background-color: #f8f9fa;
    }
    
    .carousel-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      text-align: center;
    }
    
    .carousel-controls {
      display: flex;
      justify-content: space-between;
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      padding: 0 15px;
    }
    
    .carousel-control {
      background-color: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .carousel-control:hover {
      background-color: rgba(0,0,0,0.7);
    }
    
    /* Estilos para la secci√≥n de eliminaci√≥n */
    .delete-section {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .delete-section label {
      font-weight: bold;
      margin-bottom: 15px;
      display: block;
      font-size: 18px;
      color: #e74c3c;
    }
    
    .delete-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      list-style: none;
    }
    
    .delete-list li {
      flex: 0 0 calc(20% - 15px);
      position: relative;
    }
    
    .delete-list a {
      display: block;
      border: 2px solid transparent;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    .delete-list a:hover {
      border-color: #e74c3c;
      transform: scale(1.05);
    }
    
    .small-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    
    .delete-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(231, 76, 60, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .delete-list li:hover .delete-overlay {
      opacity: 1;
    }
    
    .delete-icon {
      color: white;
      font-size: 24px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav-buttons {
        flex-direction: column;
      }
      
      .nav-button {
        width: 100%;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .delete-list li {
        flex: 0 0 calc(33.333% - 15px);
      }
      
      .carousel-item img {
        height: 300px;
      }
    }
    
    @media (max-width: 480px) {
      .delete-list li {
        flex: 0 0 calc(50% - 15px);
      }
      
      .carousel-item img {
        height: 250px;
      }
    }
  </style>
</head>

<body>
  <div id="contenedor_carga">
    <div id="carga"></div>
  </div>

  <div class="container">
    <!-- Navegaci√≥n -->
    <div class="nav-buttons">
      <a id="btn1" href="datos_personales.html" class="nav-button secondary">Datos</a>
      <a id="btn2" href="odontograma.html" class="nav-button light">Examen odontol√≥gico</a>
      <a id="btn3" href="nutricion.html" class="nav-button light">Examen Nutricional</a>
      <a id="btn4" href="psicologia.html" class="nav-button light">Examen Psicol√≥gico</a>
      <a id="btn5" href="img.html" class="nav-button secondary">Im√°genes</a>
      <a id="btn6" href="img_r.html" class="nav-button active">Radiograf√≠as</a>
      <a id="btn7" href="documentos.html" class="nav-button secondary">Documentos</a>
      <a id="btn8" href="tratamiento.html" class="nav-button secondary">Tratamiento</a>
    </div>

    <!-- Formulario para agregar radiograf√≠as -->
    <form id="radiografia-form" class="form-container">
      <input type="hidden" name="paciente" id="paciente" value="">
      <input type="hidden" name="fecha" id="fecha-actual">
      
      <div class="form-row">
        <div class="form-card">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xNCAySDZhMiAyIDAgMCAwLTIgMnYxNmEyIDIgMCAwIDAgMiAyaDEyYTIgMiAwIDAgMCAyLTJWOGwtNi02WiI+PC9wYXRoPjxwYXRoIGQ9Ik0xNCAydjZoNiI+PC9wYXRoPjxwYXRoIGQ9Ik0xNiAxM0g4Ij48L3BhdGg+PHBhdGggZD0iTTE2IDE3SDgiPjwvcGF0aD48cGF0aCBkPSJNMTAgOUg4Ij48L3BhdGg+PC9zdmc+" alt="Seleccionar">
          <div class="form-card-content">
            <p>SELECCIONAR RADIOGRAF√çA</p>
            <input type="file" name="imagen" id="imageInput" accept="image/*" required>
          </div>
        </div>
        
        <div class="form-card">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xMSA0SDRhMiAyIDAgMCAwLTIgMnYxNGEyIDIgMCAwIDAgMiAyaDE2YTIgMiAwIDAgMCAyLTJ2LTkiPjwvcGF0aD48cGF0aCBkPSJNMTguNSAyLjVhMi4xMjEgMi4xMjEgMCAwIDEgMyAzTDEyIDE1bC00IDEgMS00IDkuNS05LjV6Ij48L3BhdGg+PC9zdmc+" alt="T√≠tulo">
          <div class="form-card-content">
            <p>T√çTULO</p>
            <input type="text" name="titulo" id="titleInput" placeholder="Ingrese t√≠tulo" required>
          </div>
        </div>
        
        <div class="form-card" style="background-color: transparent; justify-content: center;">
          <button type="submit" class="submit-btn">Guardar</button>
        </div>
      </div>
    </form>

    <!-- Carrusel de radiograf√≠as -->
    <div class="carousel-container">
      <div class="carousel">
        <div class="carousel-inner" id="carousel-inner">
          <!-- Las radiograf√≠as se agregar√°n aqu√≠ din√°micamente -->
        </div>
        
        <div class="carousel-controls">
          <button class="carousel-control" id="prev-btn">‚Äπ</button>
          <button class="carousel-control" id="next-btn">‚Ä∫</button>
        </div>
      </div>
    </div>

    <!-- Secci√≥n para eliminar radiograf√≠as -->
    <div class="delete-section">
      <label>Eliminar</label>
      <ul class="delete-list" id="delete-list">
        <!-- Las miniaturas para eliminar se agregar√°n aqu√≠ din√°micamente -->
      </ul>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal" id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
      <h3>Confirmar eliminaci√≥n</h3>
      <p>¬øEst√° seguro de que desea eliminar esta radiograf√≠a?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button type="button" id="cancelDelete" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
        <button type="button" id="confirmDelete" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    // Funci√≥n para obtener par√°metros de la URL
    function getUrlParams() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split('&');
      
      for (let i = 0; i < pairs.length; i++) {
        const pair = pairs[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      
      return params;
    }

    // Funci√≥n para obtener el ID del paciente
    function obtenerIdPaciente() {
      const params = getUrlParams();
      return params.idpaciente || params.paciente;
    }

    // Funci√≥n para cargar radiograf√≠as del paciente
    function cargarRadiografiasPaciente(nombrePaciente) {
      const radiografiasPacientes = JSON.parse(localStorage.getItem('radiografiasPacientes')) || {};
      return radiografiasPacientes[nombrePaciente] || [];
    }

    // Funci√≥n para guardar radiograf√≠as del paciente
    function guardarRadiografiasPaciente(nombrePaciente, radiografias) {
      const radiografiasPacientes = JSON.parse(localStorage.getItem('radiografiasPacientes')) || {};
      radiografiasPacientes[nombrePaciente] = radiografias;
      localStorage.setItem('radiografiasPacientes', JSON.stringify(radiografiasPacientes));
    }

    // Convertir archivo a base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Variables globales
    let currentIndex = 0;
    let currentRadiografias = [];
    let deleteImageId = null;

    // Funci√≥n para actualizar el carrusel
    function updateCarousel() {
      const carouselInner = document.getElementById('carousel-inner');
      carouselInner.innerHTML = '';
      
      if (currentRadiografias.length === 0) {
        carouselInner.innerHTML = `
          <div class="carousel-item active">
            <div style="height: 400px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
              <p style="color: #6c757d;">No hay radiograf√≠as disponibles</p>
            </div>
          </div>
        `;
        return;
      }
      
      currentRadiografias.forEach((radiografia, index) => {
        const item = document.createElement('div');
        item.className = `carousel-item ${index === currentIndex ? 'active' : ''}`;
        item.innerHTML = `
          <img src="${radiografia.src}" alt="${radiografia.title}">
          <div class="carousel-caption">
            <h5>${radiografia.title}</h5>
            <p>${radiografia.fecha}</p>
          </div>
        `;
        carouselInner.appendChild(item);
      });
      
      // Actualizar posici√≥n del carrusel
      carouselInner.style.transform = `translateX(-${currentIndex * 100}%)`;
    }

    // Funci√≥n para actualizar la lista de eliminaci√≥n
    function updateDeleteList() {
      const deleteList = document.getElementById('delete-list');
      deleteList.innerHTML = '';
      
      if (currentRadiografias.length === 0) {
        deleteList.innerHTML = '<p style="color: #6c757d; text-align: center; width: 100%;">No hay radiograf√≠as para eliminar</p>';
        return;
      }
      
      currentRadiografias.forEach(radiografia => {
        const li = document.createElement('li');
        li.innerHTML = `
          <a href="#" class="delete-link" data-id="${radiografia.id}">
            <img src="${radiografia.src}" alt="${radiografia.title}" class="small-img">
            <div class="delete-overlay">
              <span class="delete-icon">üóëÔ∏è</span>
            </div>
          </a>
        `;
        deleteList.appendChild(li);
      });
      
      // Agregar event listeners a los enlaces de eliminaci√≥n
      document.querySelectorAll('.delete-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const id = this.getAttribute('data-id');
          showDeleteConfirmation(id);
        });
      });
    }

    // Mostrar modal de confirmaci√≥n
    function showDeleteConfirmation(imageId) {
      deleteImageId = imageId;
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'flex';
    }

    // Ocultar modal de confirmaci√≥n
    function hideDeleteConfirmation() {
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'none';
      deleteImageId = null;
    }

    // Eliminar radiograf√≠a
    function deleteRadiografia() {
      if (!deleteImageId) return;
      
      const nombrePaciente = document.getElementById('paciente').value;
      if (!nombrePaciente) return;
      
      const nuevasRadiografias = currentRadiografias.filter(img => img.id != deleteImageId);
      currentRadiografias = nuevasRadiografias;
      
      guardarRadiografiasPaciente(nombrePaciente, nuevasRadiografias);
      updateCarousel();
      updateDeleteList();
      
      // Resetear √≠ndice del carrusel si es necesario
      if (currentIndex >= currentRadiografias.length) {
        currentIndex = Math.max(0, currentRadiografias.length - 1);
        updateCarousel();
      }
      
      hideDeleteConfirmation();
      alert('Radiograf√≠a eliminada correctamente');
    }

    // Manejar env√≠o del formulario
    document.getElementById('radiografia-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nombrePaciente = document.getElementById('paciente').value;
      if (!nombrePaciente) {
        alert('No se ha especificado un paciente');
        return;
      }
      
      const imageInput = document.getElementById('imageInput');
      const titleInput = document.getElementById('titleInput');
      
      // Validar que se haya seleccionado una imagen
      if (imageInput.files.length === 0) {
        alert('Por favor, seleccione una radiograf√≠a');
        return;
      }
      
      // Validar que se haya ingresado un t√≠tulo
      if (!titleInput.value.trim()) {
        alert('Por favor, ingrese un t√≠tulo para la radiograf√≠a');
        return;
      }
      
      try {
        // Convertir imagen a base64
        const imageBase64 = await fileToBase64(imageInput.files[0]);
        
        // Obtener radiograf√≠as existentes
        const radiografias = cargarRadiografiasPaciente(nombrePaciente);
        
        // Crear nueva radiograf√≠a
        const nuevaRadiografia = {
          id: Date.now().toString(),
          title: titleInput.value,
          src: imageBase64,
          fecha: document.getElementById('fecha-actual').value
        };
        
        // Agregar nueva radiograf√≠a
        radiografias.push(nuevaRadiografia);
        guardarRadiografiasPaciente(nombrePaciente, radiografias);
        
        // Actualizar datos locales
        currentRadiografias = radiografias;
        currentIndex = radiografias.length - 1;
        
        // Recargar interfaz
        updateCarousel();
        updateDeleteList();
        
        // Limpiar formulario
        imageInput.value = '';
        titleInput.value = '';
        
        // Mostrar mensaje de √©xito
        alert('Radiograf√≠a guardada correctamente');
        
      } catch (error) {
        console.error('Error al procesar la radiograf√≠a:', error);
        alert('Error al procesar la radiograf√≠a. Por favor, intente nuevamente.');
      }
    });

    // Inicializaci√≥n cuando la p√°gina carga
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener ID del paciente
      const idPaciente = obtenerIdPaciente();
      
      if (idPaciente) {
        // Configurar el formulario
        document.getElementById('paciente').value = idPaciente;
        
        // Actualizar enlaces de navegaci√≥n
        const enlaces = document.querySelectorAll('.nav-button');
        enlaces.forEach(enlace => {
          const href = enlace.getAttribute('href');
          if (href && !href.includes('idpaciente=')) {
            enlace.setAttribute('href', href + '?idpaciente=' + encodeURIComponent(idPaciente));
          }
        });
        
        // Cargar radiograf√≠as del paciente
        currentRadiografias = cargarRadiografiasPaciente(idPaciente);
        updateCarousel();
        updateDeleteList();
      } else {
        alert('No se ha especificado un paciente');
      }
      
      // Establecer fecha actual
      const now = new Date();
      const formattedDate = now.toISOString().split('T')[0];
      document.getElementById('fecha-actual').value = formattedDate;
      
      // Event listeners para los controles del carrusel
      document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentRadiografias.length === 0) return;
        currentIndex = (currentIndex - 1 + currentRadiografias.length) % currentRadiografias.length;
        updateCarousel();
      });
      
      document.getElementById('next-btn').addEventListener('click', function() {
        if (currentRadiografias.length === 0) return;
        currentIndex = (currentIndex + 1) % currentRadiografias.length;
        updateCarousel();
      });
      
      // Event listeners para el modal de confirmaci√≥n
      document.getElementById('cancelDelete').addEventListener('click', hideDeleteConfirmation);
      document.getElementById('confirmDelete').addEventListener('click', deleteRadiografia);
      
      // Ocultar pantalla de carga
      setTimeout(function() {
        const contenedor = document.getElementById('contenedor_carga');
        contenedor.style.visibility = 'hidden';
        contenedor.style.opacity = '0';
      }, 500);
    });
  </script>
</body>
</html>